---
- hosts: all
  name: Provision dev server
  tasks:
    - name: "Install mac things"
      block:
        - name: Include variables from a file
          include_vars: macos/variables.yml

        - name: Cache installed Homebrew packages
          command: brew list --formula -1
          register: brew_installed_formulas
          changed_when: false
          failed_when: false

        - name: Cache installed Homebrew casks
          command: brew list --cask -1
          register: brew_installed_casks
          changed_when: false
          failed_when: false

        - name: Filter out already-installed packages
          set_fact:
            homebrew_installed_packages: "{{ homebrew_installed_packages | select('string') | reject('in', brew_installed_formulas.stdout_lines) | list + homebrew_installed_packages | select('mapping') | list }}"
            homebrew_cask_apps: "{{ homebrew_cask_apps | reject('in', brew_installed_casks.stdout_lines) | list }}"
          when:
            - brew_installed_formulas.rc == 0
            - brew_installed_casks.rc == 0

        - name: Include macOS setup
          include_tasks: macos/tasks/sudoers.yml
          when: configure_sudoers
          tags: ['sudoers']

        - name: Include macOS setup
          include_tasks: macos/tasks/osx.yml
          when: configure_osx
          tags: ['osx']

        - name: Include macOS roles
          include_role:
            name: "{{ item }}"
          loop:
            - geerlingguy.mac.homebrew
            - geerlingguy.mac.mas
      when: ansible_facts["os_family"] == "Darwin"

    - name: Include Debian setup
      include_tasks: debian/setup-debian.yml
      when: ansible_facts["os_family"] == "Debian"

    - name: Include rust role
      include_role:
        name: rust
      when: ansible_facts["os_family"] == "Debian"

    - name: Include base role
      include_role:
        name: debian/roles/base
      when: ansible_facts["os_family"] == "Debian"

    - name: Include yarn role
      include_role:
        name: roles/yarn
      when: ansible_facts["os_family"] == "Debian"

    - name: Include dotfiles role
      include_role:
        name: dotfiles

    - name: Include asdf role
      include_role:
        name: asdf

    - name: Include ohmyzsh role
      include_role:
        name: ohmyzsh

    - name: Include neovim role
      include_role:
        name: neovim
