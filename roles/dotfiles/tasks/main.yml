---
# roles/dotfiles/tasks/main.yml
# This role clones and sets up dotfiles from github.com/afromankenobi/dotfiles

# ============================================================================
# Preflight Checks
# ============================================================================

- name: Run preflight checks
  include_tasks: preflight.yml
  tags: ['preflight', 'always']

# ============================================================================
# Clone Dotfiles
# ============================================================================

- name: Clone dotfiles repository
  git:
    repo: git@github.com:afromankenobi/dotfiles.git
    dest: "{{ ansible_env.HOME }}/dotfiles"
    accept_hostkey: true
    update: yes

# ============================================================================
# Symlink configurations
# ============================================================================

- name: Symlink Vim configuration
  file:
    src: "{{ ansible_env.HOME }}/dotfiles/vim/{{ item }}"
    dest: "{{ ansible_env.HOME }}/.{{ item }}"
    state: link
    force: yes
  with_items:
    - vimrc
    - vimrc.bundles

- name: Symlink Tmux configuration
  file:
    src: "{{ ansible_env.HOME }}/dotfiles/tmux/tmux.conf"
    dest: "{{ ansible_env.HOME }}/.tmux.conf"
    state: link
    force: yes

- name: Symlink Zsh configuration
  file:
    src: "{{ ansible_env.HOME }}/dotfiles/zsh/zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc"
    state: link
    force: yes

- name: Check if zshrc.local exists
  stat:
    path: "{{ ansible_env.HOME }}/.zshrc.local
  register: zshrc_example

- name: Create zshrc.local from example if it doesn't exist
  copy:
    src: "{{ ansible_env.HOME }}/dotfiles/zshrc.local.example"
    dest: "{{ ansible_env.HOME }}/.zshrc.local"
    force: no
  when: zshrc_example.stat.exists

# ============================================================================
# Doom Emacs Setup (macOS only)
# ============================================================================

- name: Setup Doom Emacs (macOS only)
  block:
    - name: Check if Doom Emacs is already installed
      stat:
        path: "{{ ansible_env.HOME }}/.config/emacs/bin/doom"
      register: doom_installed

    - name: Clone Doom Emacs
      git:
        repo: https://github.com/doomemacs/doomemacs
        dest: "{{ ansible_env.HOME }}/.config/emacs"
        depth: 1
      when: not doom_installed.stat.exists

    - name: Install Doom Emacs
      command: "{{ ansible_env.HOME }}/.config/emacs/bin/doom install"
      when: not doom_installed.stat.exists

    - name: Create Doom config directory
      file:
        path: "{{ ansible_env.HOME }}/.config/doom"
        state: directory

    - name: Remove default Doom config files if they exist (only on first install)
      file:
        path: "{{ ansible_env.HOME }}/.config/doom/{{ item }}"
        state: absent
      with_items:
        - config.el
        - packages.el
      when: not doom_installed.stat.exists

    - name: Symlink Doom Emacs configuration
      file:
        src: "{{ ansible_env.HOME }}/dotfiles/doom/{{ item }}"
        dest: "{{ ansible_env.HOME }}/.config/doom/{{ item }}"
        state: link
        force: yes
      with_items:
        - config.org
        - packages.org
        - init.el

    - name: Run doom sync to generate config from org files
      command: "{{ ansible_env.HOME }}/.config/emacs/bin/doom sync"
      register: doom_sync_result
      changed_when: "'Synchronizing' in doom_sync_result.stdout"
  when: ansible_os_family == "Darwin"

# ============================================================================
# Neovim (Optional - only if nvimrc.lua exists)
# ============================================================================

- name: Setup Neovim configuration (if nvimrc.lua exists)
  block:
    - name: Check if nvimrc.lua exists in dotfiles
      stat:
        path: "{{ ansible_env.HOME }}/dotfiles/vim/nvimrc.lua"
      register: nvimrc_exists

    - name: Create Neovim config directory
      file:
        path: "{{ ansible_env.HOME }}/.config/nvim"
        state: directory
      when: nvimrc_exists.stat.exists

    - name: Symlink Neovim configuration
      file:
        src: "{{ ansible_env.HOME }}/dotfiles/vim/nvimrc.lua"
        dest: "{{ ansible_env.HOME }}/.config/nvim/init.lua"
        state: link
        force: yes
      when: nvimrc_exists.stat.exists

# ============================================================================
# asdf default package configurations
# ============================================================================

- name: Symlink asdf default package configurations
  file:
    src: "{{ ansible_env.HOME }}/dotfiles/{{ item }}"
    dest: "{{ ansible_env.HOME }}/.{{ item }}"
    state: link
    force: yes
  with_items:
    - default-gems
    - default-npm-packages
    - default-python-packages
    - default-elixir-packages
    - default-golang-packages
    - default-cargo-crates
