---
# Configure shell initialization for asdf

# ============================================================================
# Zsh Configuration (via ohmyzsh)
# ============================================================================

- name: Check if .zshrc exists
  stat:
    path: "{{ ansible_facts["env"]["HOME"] }}/.zshrc"
  register: zshrc_stat

- name: Add asdf to ohmyzsh plugins
  lineinfile:
    path: "{{ ansible_facts["env"]["HOME"] }}/.zshrc"
    regexp: '^plugins=\((.*)\)$'
    line: 'plugins=(\1 asdf)'
    backrefs: yes
  when: zshrc_stat.stat.exists
  # Only add if not already present
  register: zsh_plugins_check
  failed_when: false

# Alternative approach if the regex doesn't find plugins line
- name: Check if asdf plugin already in .zshrc
  shell: grep -q "plugins=(.*asdf.*)" {{ ansible_facts["env"]["HOME"] }}/.zshrc
  register: asdf_in_zsh
  failed_when: false
  changed_when: false
  when: zshrc_stat.stat.exists

- name: Manually add asdf to plugins if needed
  replace:
    path: "{{ ansible_facts["env"]["HOME"] }}/.zshrc"
    regexp: '^(plugins=\([^)]*)\)$'
    replace: '\1 asdf)'
  when:
    - zshrc_stat.stat.exists
    - asdf_in_zsh.rc != 0

# ============================================================================
# Bash Configuration
# ============================================================================

- name: Check if .bashrc exists
  stat:
    path: "{{ ansible_facts["env"]["HOME"] }}/.bashrc"
  register: bashrc_stat

- name: Detect asdf installation path (macOS)
  stat:
    path: /opt/homebrew/opt/asdf/libexec/asdf.sh
  register: asdf_macos_brew_path
  when: ansible_facts["os_family"] == "Darwin"

- name: Detect asdf installation path (Debian)
  stat:
    path: /usr/share/asdf/asdf.sh
  register: asdf_debian_path
  when: ansible_facts["os_family"] == "Debian"

- name: Set asdf source path for macOS
  set_fact:
    asdf_source_path: /opt/homebrew/opt/asdf/libexec/asdf.sh
  when:
    - ansible_facts["os_family"] == "Darwin"
    - asdf_macos_brew_path.stat.exists

- name: Set asdf source path for Debian
  set_fact:
    asdf_source_path: /usr/share/asdf/asdf.sh
  when:
    - ansible_facts["os_family"] == "Debian"
    - asdf_debian_path.stat.exists

- name: Add asdf initialization to .bashrc
  lineinfile:
    path: "{{ ansible_facts["env"]["HOME"] }}/.bashrc"
    state: present
    create: yes
    regexp: '^\. .*/asdf\.sh$'
    line: ". {{ asdf_source_path }}"
  when:
    - bashrc_stat.stat.exists
    - asdf_source_path is defined
